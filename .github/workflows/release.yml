name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (skip release creation and PyPI publish)"
        type: boolean
        default: true

jobs:
  release:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      models: read

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Extract version from pyproject.toml
        id: version
        run: |
          VERSION=$(grep -E "^version = " pyproject.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT

      - name: Check if release already exists
        id: check_release
        run: |
          if gh release view "v${{ steps.version.outputs.version }}" > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build package
        if: steps.check_release.outputs.exists == 'false'
        run: uv build

      - name: Gather release context
        if: steps.check_release.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          # Commits since last tag
          if [ -n "$LAST_TAG" ]; then
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          else
            COMMITS=$(git log -20 --pretty=format:"- %s (%h)" --no-merges)
          fi

          # Merged PR titles and bodies
          PRS=""
          if [ -n "$LAST_TAG" ]; then
            TAG_DATE=$(git log -1 --format=%aI "$LAST_TAG")
            PRS=$(gh pr list --state merged --search "merged:>=${TAG_DATE}" \
              --json title,body,number --limit 50 \
              --jq '.[] | "### PR #\(.number): \(.title)\n\(.body // "No description.")\n"' 2>/dev/null || echo "")
          fi

          # Diffstat
          if [ -n "$LAST_TAG" ]; then
            DIFFSTAT=$(git diff --stat "${LAST_TAG}..HEAD" | tail -1)
          else
            DIFFSTAT=$(git diff --stat HEAD~10..HEAD | tail -1)
          fi

          cat > /tmp/release_context.txt << CTXEOF
          Version: ${VERSION}
          Previous version: ${LAST_TAG:-"(first release)"}
          Diffstat: ${DIFFSTAT}

          ## Commits
          ${COMMITS}

          ## Pull Requests
          ${PRS}
          CTXEOF
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate AI release summary
        if: steps.check_release.outputs.exists == 'false'
        id: ai_summary
        run: |
          CONTEXT=$(cat /tmp/release_context.txt)
          VERSION="${{ steps.version.outputs.version }}"

          PROMPT="You are writing release notes for an open-source Python project called LegacyLipi (a PDF translator for legacy Indian font encodings). Generate a concise, professional release summary for v${VERSION}.

          Rules:
          - Start with a 1-2 sentence highlight of what this release brings
          - Group changes into sections: Features, Fixes, Breaking Changes (only if applicable)
          - Use bullet points, keep each point to one line
          - Do NOT include installation instructions (added separately)
          - Do NOT use emojis
          - Be factual, derive everything from the context below
          - If this is a major version bump, mention it

          Context:
          ${CONTEXT}"

          RESPONSE=$(curl -sf https://models.inference.ai.azure.com/chat/completions \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg prompt "$PROMPT" \
              '{
                model: "gpt-4o",
                max_tokens: 1024,
                temperature: 0.3,
                messages: [{role: "user", content: $prompt}]
              }')" 2>&1) || true

          SUMMARY=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty' 2>/dev/null)

          if [ -n "$SUMMARY" ]; then
            echo "$SUMMARY" > /tmp/ai_summary.md
            echo "generated=true" >> $GITHUB_OUTPUT
          else
            echo "generated=false" >> $GITHUB_OUTPUT
            echo "AI summary unavailable, using fallback" >&2
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Compose release notes
        if: steps.check_release.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          if [ "${{ steps.ai_summary.outputs.generated }}" = "true" ]; then
            cp /tmp/ai_summary.md release_notes.md
          else
            # Fallback: commit list
            LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
            if [ -n "$LAST_TAG" ]; then
              COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s" --no-merges)
            else
              COMMITS=$(git log -20 --pretty=format:"- %s" --no-merges)
            fi

            cat > release_notes.md << EOF
          ## What's Changed

          ${COMMITS}
          EOF
          fi

          # Append installation instructions
          cat >> release_notes.md << EOF

          ---

          ### Installation

          \`\`\`bash
          pip install legacylipi==${VERSION}
          uv tool install legacylipi==${VERSION}
          uvx legacylipi api
          \`\`\`
          EOF

      - name: Preview release notes (dry run)
        if: steps.check_release.outputs.exists == 'false' && inputs.dry_run == true
        run: |
          echo "::notice::DRY RUN â€” skipping release creation and PyPI publish"
          echo "--- Generated release notes ---"
          cat release_notes.md

      - name: Create GitHub Release
        if: steps.check_release.outputs.exists == 'false' && inputs.dry_run != true
        run: |
          gh release create "${{ steps.version.outputs.tag }}" \
            dist/legacylipi-${{ steps.version.outputs.version }}-py3-none-any.whl \
            dist/legacylipi-${{ steps.version.outputs.version }}.tar.gz \
            --title "v${{ steps.version.outputs.version }}" \
            --notes-file release_notes.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to PyPI
        if: steps.check_release.outputs.exists == 'false' && inputs.dry_run != true
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}

      - name: Skip release (already exists)
        if: steps.check_release.outputs.exists == 'true'
        run: |
          echo "Release v${{ steps.version.outputs.version }} already exists, skipping."
